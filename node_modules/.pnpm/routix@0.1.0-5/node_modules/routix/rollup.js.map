{"version":3,"file":"rollup.js","sources":["src/rollup.js"],"sourcesContent":["import resolveRoutix from './routix.js'\n\nconst noWriteWarning =\n  'Both routes and tree generation are disabled, routix will do nothing'\n\n/**\n * prevent the build from running, until routes.js is completely generated\n *\n * FIXME Nollup 0.9.0 does not implement buildStart correctly (but\n *       renderStart kicks in too late to prevent Rollup from using an\n *       already existing routes.js...)\n *\n * NOTE watchDelay option\n *\n * this is intented to prevent a nasty race with\n * rollup-plugin-hot/autoccreate\n *\n * autocreate plugin is needed for HMR stability because Rollup crashes\n * and can't recover when it tries to import a missing file. autocreate\n * mitigates this by creating empty missing files; thus allowing Rollup\n * to keep humming\n *\n * the race however goes like this:\n *\n * - user rename/delete page file\n * - rollup picks file change\n * - rollup triggers build\n * - rollup-plugin-hot/autocreate sees deleted file in routes.js\n * - autocreate recreates just deleted file <--- HERE BE BUG\n * - routix picks file change\n * - routix recreates routes.js\n * - ... but too late, user has extraneous deleted file recreated\n * - rollup picks the change in routes.js...\n *\n * this delay is intented to give some time to routix to pick the\n * change first (and so rollup plugin will block start of rollup build\n * until routes.js has been generated)\n *\n * we can't be too greedy, because this delay will be paid for _any_\n * file change when user is working, even when unneeded (and in this\n * case the delay will be consumed in full -- nominal case is worst\n * case) :-/\n *\n * 20ms seems to work on my machine\n */\n\nexport default function rollupPluginRoutix(arg) {\n  const {\n    start,\n    isWatchedFile,\n    onIdle,\n    isWriteTarget,\n    options: { watchDelay, write },\n  } = resolveRoutix(arg)\n\n  const readyPromise = start()\n\n  return {\n    name: 'routix',\n\n    // prevent build from starting until Routix has finished generating\n    // routes.js (or Rollup would do a useless build with stalled routes.js)\n    //\n    // NOTE we only need to wait before routes.js or tree.js, or a file that\n    // is under our watch (because this will end up with a rebuild)\n    //\n    // NOTE watchDelay is needed to ensure that Routix's file watcher picks the\n    // change event before Rollup (see details above)\n    //\n    async load(id) {\n      // NOTE onIdle rethrows (and flushes) build / parse errors\n      try {\n        if (isWriteTarget(id) || isWatchedFile(id)) {\n          await onIdle(watchDelay)\n        }\n      } catch (err) {\n        if (err.errors) err.errors.forEach(e => this.error(e))\n        else this.error(err)\n      }\n    },\n\n    async buildStart() {\n      try {\n        if (!write.routes && !write.tree) {\n          this.warn(noWriteWarning)\n          return\n        }\n\n        // catch & report start errors\n        await readyPromise\n      } catch (err) {\n        this.error(err)\n      }\n    },\n  }\n}\n"],"names":["resolveRoutix"],"mappings":";;;;;;;;AAEA,MAAM,cAAc;AACpB,EAAE,uEAAsE;AACxE;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACe,SAAS,kBAAkB,CAAC,GAAG,EAAE;AAChD,EAAE,MAAM;AACR,IAAI,KAAK;AACT,IAAI,aAAa;AACjB,IAAI,MAAM;AACV,IAAI,aAAa;AACjB,IAAI,OAAO,EAAE,EAAE,UAAU,EAAE,KAAK,EAAE;AAClC,GAAG,GAAGA,MAAa,CAAC,GAAG,EAAC;AACxB;AACA,EAAE,MAAM,YAAY,GAAG,KAAK,GAAE;AAC9B;AACA,EAAE,OAAO;AACT,IAAI,IAAI,EAAE,QAAQ;AAClB;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,IAAI,MAAM,IAAI,CAAC,EAAE,EAAE;AACnB;AACA,MAAM,IAAI;AACV,QAAQ,IAAI,aAAa,CAAC,EAAE,CAAC,IAAI,aAAa,CAAC,EAAE,CAAC,EAAE;AACpD,UAAU,MAAM,MAAM,CAAC,UAAU,EAAC;AAClC,SAAS;AACT,OAAO,CAAC,OAAO,GAAG,EAAE;AACpB,QAAQ,IAAI,GAAG,CAAC,MAAM,EAAE,GAAG,CAAC,MAAM,CAAC,OAAO,CAAC,CAAC,IAAI,IAAI,CAAC,KAAK,CAAC,CAAC,CAAC,EAAC;AAC9D,aAAa,IAAI,CAAC,KAAK,CAAC,GAAG,EAAC;AAC5B,OAAO;AACP,KAAK;AACL;AACA,IAAI,MAAM,UAAU,GAAG;AACvB,MAAM,IAAI;AACV,QAAQ,IAAI,CAAC,KAAK,CAAC,MAAM,IAAI,CAAC,KAAK,CAAC,IAAI,EAAE;AAC1C,UAAU,IAAI,CAAC,IAAI,CAAC,cAAc,EAAC;AACnC,UAAU,MAAM;AAChB,SAAS;AACT;AACA;AACA,QAAQ,MAAM,aAAY;AAC1B,OAAO,CAAC,OAAO,GAAG,EAAE;AACpB,QAAQ,IAAI,CAAC,KAAK,CAAC,GAAG,EAAC;AACvB,OAAO;AACP,KAAK;AACL,GAAG;AACH;;;;"}