{"version":3,"file":"snowpack.js","sources":["lib/snowpack-svenchify.js","lib/snowpack-plugin.js"],"sourcesContent":["/**\n *     import { svenchify } from 'svench/snowpack'\n *\n *     module.exports = svenchify('snowpack.config.js', {\n *       ...\n *     })\n */\nimport { SNOWPACK_PLUGIN } from './const.js'\n\nconst isSveltePlugin = x =>\n  Array.isArray(x) ? isSveltePlugin(x[0]) : x === '@snowpack/plugin-svelte'\n\nconst wrapSveltePlugin = options => plugin => {\n  if (!isSveltePlugin(plugin)) return plugin\n  const [sveltePlugin, svelte] = Array.isArray(plugin) ? plugin : [plugin, {}]\n  return [SNOWPACK_PLUGIN, { sveltePlugin, svelte, ...options }]\n}\n\nexport default (snowpackConfig, svenchifyOptions = true) => {\n  const enabled =\n    svenchifyOptions === true || (svenchifyOptions && svenchifyOptions.enabled)\n\n  if (!enabled) return snowpackConfig\n\n  return {\n    ...snowpackConfig,\n    plugins: snowpackConfig.plugins.map(\n      wrapSveltePlugin({ enabled, ...svenchifyOptions })\n    ),\n  }\n}\n","import * as path from 'path'\n\nimport { createPluginParts } from './plugin-shared.js'\nimport { createIndex } from './template.js'\nimport { writeManifest } from './service-manifest.js'\nimport { maybeDump } from './dump.js'\nimport { mkdirp } from './util.js'\nimport { SNOWPACK_PLUGIN } from './const.js'\n\nconst defaultPresets = 'svench/presets/snowpack'\n\nconst uniq = arr => [...new Set(arr)]\n\nconst resolveSveltePlugin = x =>\n  typeof x === 'function' ? x : require.main.require(x)\n\nconst initSvench = ({ options, routix }) => async ({ isDev }) => {\n  const {\n    manifest,\n    index: indexCfg,\n    manifestDir,\n    publicDir,\n    entryFile,\n  } = options\n\n  // --- Manifest ---\n\n  const runManifest = async () => {\n    if (!manifest) return\n    await writeManifest(options)\n  }\n\n  // --- Index ---\n\n  const runIndex = async () => {\n    if (!indexCfg) return\n    await createIndex(indexCfg, {\n      watch: isDev,\n      script: '/_svench_/' + path.basename(entryFile),\n      publicDir,\n    })\n  }\n\n  const startRoutix = async () => {\n    await mkdirp(manifestDir)\n    await routix.start({ watch: isDev })\n    // await routix.onIdle(100) // report init errors\n  }\n\n  await Promise.all([runIndex(), runManifest(), startRoutix()])\n}\n\nconst autoMount = ({ manifestDir, publicDir }, snowpackConfig) => {\n  const { mount } = snowpackConfig\n\n  const mountEntries = [[path.resolve(publicDir), { url: '/', static: true }]]\n\n  let manifestDirEntry = [\n    path.resolve(manifestDir),\n    { url: '/_svench_', resolve: true, static: false },\n  ]\n\n  for (const [target, spec] of Object.entries(mount)) {\n    if (manifestDirEntry && !spec.static) {\n      mountEntries.push(manifestDirEntry)\n      manifestDirEntry = null\n    }\n    mountEntries.push([target, spec])\n  }\n\n  if (manifestDirEntry) {\n    mountEntries.push(manifestDirEntry)\n  }\n\n  return Object.fromEntries(mountEntries)\n}\n\nexport const plugin = (snowpackConfig, pluginOptions = {}) => {\n  const { svelte: sveltePluginOptions, ...svenchOptions } = pluginOptions\n\n  let resolveRouteImport = x => x\n\n  const parts = createPluginParts({\n    presets: defaultPresets,\n    ...svenchOptions,\n    resolveRouteImport: (...args) => resolveRouteImport(...args),\n  })\n\n  const {\n    options: {\n      enabled,\n      sveltePlugin = '@snowpack/plugin-svelte',\n      dump,\n      dir,\n      port,\n      extensions,\n      snowpack: override,\n    },\n  } = parts\n\n  const _sveltePlugin = resolveSveltePlugin(sveltePlugin)\n\n  // --- Guard: Svench disabled ---\n\n  if (!enabled) {\n    return _sveltePlugin(snowpackConfig, sveltePluginOptions)\n  }\n\n  // --- Svench enabled ---\n\n  sveltePluginOptions.preprocess = {\n    markup: parts.preprocess.pull,\n  }\n\n  if (port) {\n    snowpackConfig.devOptions = {\n      ...snowpackConfig.devOptions,\n      port,\n    }\n  }\n\n  if (override) {\n    const { mount, ...others } = override\n\n    if (mount === true) {\n      snowpackConfig.mount = autoMount(parts.options, snowpackConfig)\n    } else if (mount) {\n      snowpackConfig.mount = mount\n    }\n\n    for (const [key, value] of Object.entries(others)) {\n      if (key.endsWith('Options')) {\n        snowpackConfig[key] = { ...snowpackConfig[key], ...value }\n      } else {\n        snowpackConfig[key] = value\n      }\n    }\n  }\n\n  const distDir = path.resolve(dir)\n  const mountEntry = snowpackConfig.mount[distDir]\n  if (mountEntry) {\n    const { url } = mountEntry\n    resolveRouteImport = x => url + '/' + path.relative(distDir, x)\n  }\n\n  const hooks = _sveltePlugin(snowpackConfig, sveltePluginOptions)\n\n  hooks.resolve.input = uniq([\n    ...hooks.resolve.input,\n    ...extensions.map(x => '.' + x.split('.').pop()),\n  ])\n\n  hooks.knownEntrypoints = uniq([\n    ...hooks.knownEntrypoints,\n    'svench',\n    // TODO only if enabled in manifest:\n    'svench/src/app/index.js',\n    'svench/themes/default.css',\n    'svench/themes/default-markdown.css',\n  ])\n\n  return {\n    ...hooks,\n    name: SNOWPACK_PLUGIN,\n    config: maybeDump('config', dump),\n    run: initSvench(parts),\n  }\n}\n\nexport default plugin\n\nexport { default as svenchify } from './snowpack-svenchify.js'\n"],"names":["SNOWPACK_PLUGIN","writeManifest","createIndex","path.basename","mkdirp","path.resolve","createPluginParts","path.relative","maybeDump"],"mappings":"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"}